<html>
    <head>
        <title>Exam starts</title>
        <script>
               document.addEventListener('DOMContentLoaded', function () {
                function DSeconds(){
                    var i = document.getElementById("Time").innerHTML;
                    document.getElementById("Time").innerHTML=--i;
                    if(i == 0){
                        document.getElementById("Time").innerHTML = "Time Ends";
                        questions_number += 1;
                        loadQuestion();
                    }
                }
                setInterval(DSeconds, 1000);
                });
        </script>
        <style>
            header{
                position: relative;
                margin-top: -0.15cm;
                background-color:#461EEA;
                width: 99.5%;
                height:1.5cm;
                border-radius:4px;
                border:solid 1px grey;
            }
            header>.roll{
                position: absolute;
                font-size: 25px;
                font-family:sans-serif;
                text-align: center;
                margin-left: 5%;
                margin-top: 3px;
                background-color: white;
                border-radius:40px;
                border:solid 0px grey;
                padding:0.8%;
            }
            header>.timer{
                position: absolute;
                font-size: 25px;
                font-family:sans-serif;
                text-align: center;
                margin-left: 35%;
                background-color: white;
                border-radius:20px;
                border:solid 1px grey;
                height: 50%;
                padding-top: 0.8%;
                width:25%;
                color: red;
                margin-top:8px;
            }
            .question{
                position: relative;
                width: 99.5%;
                height: 40%;
                padding:12px;
                border-radius: 15px;
                margin-top: 3px;
            }
            button{
                position: relative;
                margin-left:30px;
                text-align:left;
                background-color:white;
                font-size:16px;
                border:0px;
                margin-top:0.5%;
                width:600px;
                height:80px;
                border-radius:15px;
                border:solid 1px grey;
            }
            .options>button:hover{
                position: inherit;
                background-color:red;
                color:white;
            }
            .small{
                position: relative;
                margin-top: 6%;
                font-size:18px;
                width:100%;
                height:1cm;
                background-color:#461EEA;
                color:white;
                padding-top:1%;
                text-align:center;
                font-family: sans-serif;
                border-radius:4px;
            }
            .question{
                position: relative;
                display:table;
                background-color:#F2F4F7;
                text-align: center;

            }.question>div{
                position:relative;
                margin-top:-1% ;
                margin-left: -2%;
            }
            .question>div>span{
                position:relative;
                margin-top: -5%;
                font-family:sans-serif;
                font-size: 22px;
            }
            .submitanswers{
                position:absolute;
                top:33%;
                right:2%;
                font-family: sans-serif;
                border-radius:15px;
                font-size:15px;
                background-color:blue;
                color:white;
                border:0px;
            }
            .submitanswers:hover{
                background-color:red;
        }
        </style>
        <script src ="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js" ></script>
        <script>
         window.onbeforeunload = function() { return "Your answers may be lost."; };
                let questions_number;
                let questions = [];
                let answers = [];
                let roll = '{{Roll}}'

                if(localStorage.getItem('questions_number') != null){
                    questions_number = parseInt(localStorage.getItem('questions_number'));
                    questions = JSON.parse(localStorage.getItem('questions'));
                    answers = JSON.parse(localStorage.getItem('answers'));
                    console.log(questions_number)
                }
                else{
                    questions_number = 0;

                    {% for r in questionPaper %}
                        questions.push({
                            question:'{{ r.Question }}',
                            options:_.shuffle(["{{ r.option1 }}","{{ r.option2 }}","{{ r.option3 }}","{{ r.option4 }}"]),
                            Time:"{{ r.Time }}",
                            Images:"{{ r.imageTOrF }}",
                            subject :"{{ r.subject }}"
                        });
                    {% endfor %}
                }
                 document.addEventListener("DOMContentLoaded",() =>{
                      window.onbeforeunload = function() { return "Your work will be lost."; };
                    loadQuestion();
                });
                window.onbeforeunload = function() { return "Your work will be lost."; };
            function loadQuestion(){
                     if(questions_number == (questions.length)){
                            const subject = questions[questions_number-1].subject
                            console.log(subject)
                            localStorage.removeItem('questions_number');
                            localStorage.removeItem('questions',questions);
                            localStorage.removeItem('answers',answers);
                            localStorage.removeItem('Roll')

                            fetch('/'+subject+'/doneExam/'+roll,{
                                method:"POST",
                                credentials:'include',
                                body:JSON.stringify(answers),
                                cache: 'no-cache',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                            });
                            document.write("<h1 style='text-align:center;'>Your exam has been completed and result has been submitted</h1>");

                            }
                if(questions[questions_number].Images == "T"){
                    let div = document.querySelector("#img");
                    div.style.display = "block";
                    {%for a, b in data%}
                        if("{{a}}" == questions[questions_number].question){
                            div.innerHTML = "<img src='data:;base64,{{ b }}' style='width:500px;height:350px;'>"
                        }
                            {%endfor%}
                        }
                document.querySelector(".q").innerHTML = questions[questions_number].question;
                document.querySelector("#Qno").innerHTML = questions_number+1 +"/"+questions.length;
                document.querySelector("#Time").innerHTML = questions[questions_number].Time;
                const options = document.querySelector(".options");
                options.innerHTML = "";


                localStorage.setItem('questions_number',questions_number);
                localStorage.setItem('questions', JSON.stringify(questions));
                localStorage.setItem('answers', JSON.stringify(answers));
                localStorage.setItem('Roll','{{Roll}}')


                for (const option of questions[questions_number].options){
                    options.innerHTML += `<button class="option">${option}</button>`;
                }
                document.querySelectorAll(".option").forEach((option) =>{

                    option.onclick = () => {

                        let opt = option.textContent;
                        answers.push({
                         [questions[questions_number].question] : opt
                        });
                        questions_number +=1;
                                                let div = document.querySelector("#img");
                        div.style.display = "none";
                        loadQuestion();
                    }
                });
            }
            function submitAnswers(){
                 let r=confirm("Are you really wants to submit your answers and finish your exam?");
                if(r==true){
                    questions_number = (questions.length)
                    loadQuestion();
                }else{
                    return false
                }
            }
        </script>
    </head>
    <body  onmousedown='return false;' onselectstart='return false;'>
    <div>
        <header>
            <span class="roll">{{Roll}}</span>

            <span class="timer" id="Time"></span>

            <span class="roll" id="Qno" style="position: relative; float: right;margin-right:4%;">{{s}}/{{l}}</span>
        </header>
         <div class="question">
            <div onmousedown='return false;' onselectstart='return false;'><span class="q"></span></div>
            <input class="submitAnswers" value="Submit answers" type="submit" onclick="return submitAnswers()"/>
            <div style="padding-top:1%;" id="img" >

            </div>
            </div>
        <div class="options" style="position: relative;">
        </div>
        <footer class="small"> <span style="color:white;">Please select an option</span></footer>
    </div>
    <div id="pW" style="display=none">
    </div>
    </body>
</html>